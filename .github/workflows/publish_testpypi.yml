name: Publish to TestPyPI

on:
  push:
    branches: [ dev_setup ]

concurrency:
  group: publish-testpypi-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    env:
      # Expose token to Poetry (no ~/.pypirc needed)
      POETRY_PYPI_TOKEN_TESTPYPI: ${{ secrets.TESTPYPI_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Install project (no dev deps needed to build)
        run: poetry install --only main --no-root

      - name: Configure TestPyPI repo
        run: poetry config repositories.testpypi https://test.pypi.org/legacy/

      # ---- Auto-bump to a unique version so TestPyPI accepts the upload ----
      # Strategy: turn the current version into a post release: X.Y.Z.post<run_number>
      - name: Show current version
        run: poetry version -s

      - name: Bump version for TestPyPI
        shell: bash
        run: |
          BASE_VERSION="$(poetry version -s)"
          # Strip any existing .postN and append current run number for uniqueness
          CLEAN_BASE="${BASE_VERSION%%.post*}"
          NEW_VERSION="${CLEAN_BASE}.post${GITHUB_RUN_NUMBER}"
          echo "Setting version to ${NEW_VERSION}"
          poetry version "${NEW_VERSION}"
          poetry version -s

      - name: Build dist
        run: poetry build

      - name: Publish to TestPyPI
        run: poetry publish -r testpypi --no-interaction --skip-existing --verbose
